---
id: RFC-0005
title: Environment Export and Exec Invocation Contracts
status: Draft
decision_date: 2025-09-25
approvers:
  - TBD
related_features:
  - features/cli/env.feature:1
  - features/cli/hooks.feature:1
  - features/cli/task.feature:1
---

## Summary

This RFC formalises how cuenv derives, filters, and surfaces environment variables through the `env print`, `env check`, and `exec` commands. The implementation in [crates/cuenv-cli/src/commands/env.rs](crates/cuenv-cli/src/commands/env.rs:6) and [crates/cuenv-cli/src/commands/exec.rs](crates/cuenv-cli/src/commands/exec.rs:10) already encodes key behaviours such as secret elision and shell-specific formatting. By documenting the user-facing contract we ensure that features, documentation, and future extensions preserve predictable semantics.

## Problem Statement

cuenv exposes multiple ways to interact with evaluated environments:

- Printing variables for inspection (`env print`).
- Loading them into shells after hook completion (`env check`, `export`).
- Running ad-hoc commands within the prepared environment (`exec`).

Without a canonical contract:

- Scripts cannot rely on consistent filtering or export syntax.
- Shell integrations may diverge when interpreting exported data.
- Feature specifications remain underspecified, especially while files such as [features/cli/env.feature](features/cli/env.feature:1) are empty.

## Goals

1. Specify how environment data is serialised for `env print` across supported formats.
2. Define the contract for `env check`/`export` in shell contexts (Bash, Zsh, Fish), including secret handling.
3. Clarify how `exec` applies environment variables and propagates exit codes.
4. Establish invariants shared with hook lifecycle decisions (RFC-0003).

## Non-goals

- Redesigning secret resolution or manifest schema (handled in cuenv-core).
- Defining hook approval behaviour (delegated to RFC-0003/ADR-0001).
- Adding support for new shells or operating systems.

## Proposed Approach

1. **Environment Serialisation**

   - `env print` sorts keys alphabetically and omits values marked as `[SECRET]`, matching `format_as_env_vars`.
   - JSON format uses `serde_json::to_string_pretty` and strictly emits the `Env` structure (with secrets removed).

2. **Shell Export Contract**

   - `env check` and the hidden `export` command emit shell-specific expressions using the same filtered data set.
   - Exports include hook-produced variables (`state.environment_vars`) while ensuring secrets remain absent.

3. **`exec` Invocation Rules**

   - Construct the command environment via `Environment::build_for_exec`, enabling policy enforcement (e.g. allow lists).
   - Propagate the underlying process exit code and integrate with the error envelope scheme from RFC-0002.

4. **Consistency Guarantees**

   - All environment derivations must rely on canonical builder functions from cuenv-core to avoid drift.
   - Shell scripts generated by `shell init` are treated as consumers of this contract.

5. **Testing and Validation**
   - Add scenarios to [features/cli/env.feature](features/cli/env.feature:1) covering exports and secret filtering.
   - Extend integration tests to include snapshots of shell exports.

## Alternatives Considered

| Option                                  | Outcome       | Reason Rejected                           |
| --------------------------------------- | ------------- | ----------------------------------------- |
| Allow secrets by default in `env print` | Convenience   | Violates security stance and ADR-0004     |
| Provide shell-agnostic export output    | Simplicity    | Forces users to add wrappers, weaker UX   |
| Force `exec` to capture STDOUT/STDERR   | Debuggability | Removes ability to stream output natively |

## Impact on Users

- Users can confidently script `cuenv env print` and `cuenv exec` knowing secrets are protected.
- Shell integration remains predictable across supported shells.
- Downstream tooling can parse outputs without reverse engineering.

## Migration Plan

- Publish this RFC and align documentation in README and quick start guides.
- Populate [features/cli/env.feature](features/cli/env.feature:1) with scenarios referencing this contract.
- Ratify behaviour via ADR-0004 once stabilised.

## Features Alignment

| Feature Specification                                        | Coverage                                | Notes                                                               |
| ------------------------------------------------------------ | --------------------------------------- | ------------------------------------------------------------------- |
| [features/cli/env.feature](features/cli/env.feature:1)       | Pending scenarios for print/export/exec | Will validate filtering and shell exports.                          |
| [features/cli/hooks.feature](features/cli/hooks.feature:104) | Environment persistence scenario        | Depends on the export contract defined here.                        |
| [features/cli/task.feature](features/cli/task.feature:1)     | Pending                                 | Task execution may reference environment behaviour for subcommands. |

## Open Questions

1. Should we expose a machine-readable schema describing exported variables (e.g. metadata about secrets)?
2. How do we support custom shell integrations, such as PowerShell or Nushell, without fragmenting the contract?
3. Do we need per-command toggles to include secrets for trusted CI environments?

## Related Artifacts

| Artifact                                                                                                                 | Purpose                                                       |
| ------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------- |
| [crates/cuenv-cli/src/commands/env.rs](crates/cuenv-cli/src/commands/env.rs:6)                                           | Environment extraction and formatting logic.                  |
| [crates/cuenv-cli/src/commands/exec.rs](crates/cuenv-cli/src/commands/exec.rs:10)                                        | Exec command environment application.                         |
| [crates/cuenv-cli/src/commands/hooks.rs](crates/cuenv-cli/src/commands/hooks.rs:238)                                     | Export integration post-hook execution.                       |
| [docs/adrs/adr-0004-environment-export-filtering-policy.md](docs/adrs/adr-0004-environment-export-filtering-policy.md:1) | Ratified decision that enforces filtering rules defined here. |
