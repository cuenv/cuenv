---
id: ADR-0002
title: Background Hook Execution and Prompt-Handler Lifecycle
status: Accepted
decision_date: 2025-09-25
approvers:
  - Core Maintainers
related_features:
  - features/cli/hooks.feature:9
  - features/cli/hooks.feature:45
  - features/cli/hooks.feature:78
supersedes: []
superseded_by: []
---

## Context

cuenv’s shell integration spawns hooks asynchronously so developers can keep working while environment setup completes. The implementation at [crates/cuenv-cli/src/commands/hooks.rs](crates/cuenv-cli/src/commands/hooks.rs:238) uses prompt- or directory-change hooks (for example: `PROMPT_COMMAND` in Bash, `precmd`/`preexec` in Zsh, and `on-variable PWD` in Fish) to trigger the export flow on each prompt. These handlers are implemented to be safe and idempotent: when no work is required the export flow is a fast no-op.

This ADR depends on the workflow outlined in [docs/rfcs/rfc-0003-shell-integration-workflow-and-hook-lifecycle.md](docs/rfcs/rfc-0003-shell-integration-workflow-and-hook-lifecycle.md:1).

## Decision

1. **Asynchronous Execution**
   - `cuenv env load` MUST execute hooks in the background using `HookExecutor::execute_hooks_background`, freeing the invoking shell immediately after scheduling.

2. **Prompt-hook handlers and lifecycle (current behaviour)**
   - Shell integration scripts generated by `cuenv shell init` register prompt/drive hooks that invoke the hidden export flow on prompt or directory change (for example: `PROMPT_COMMAND` in Bash, `precmd` hooks in Zsh, and `on-variable PWD` in Fish).
   - These handlers are safe and idempotent: the `export` path is implemented as a no-op when there is no work to do (no `env.cue`, no pending hooks, or no completed state to apply).
   - The implementation does not currently perform automatic deregistration of these handlers after a one-time execution; they remain installed to provide continuous integration across prompts. Implementing automatic deregistration (self-unload) is a desirable future enhancement but is not required for correctness today.

3. **Polling Contract**
   - `cuenv env status` and `cuenv env check` MUST inspect hook progress via `HookExecutor::get_execution_status_for_instance`, ensuring consistent status reporting across shells.

4. **Failure Handling**
   - Failed hooks MUST NOT inject environment variables (ties into ADR-0004). The CLI SHOULD surface diagnostic output indicating failure.
   - Failed executions will still attempt to clean up supervisor state. Shell-side handlers remain installed but are safe: subsequent prompt evaluations will run the `export` flow which will detect the absence of a completed state and act as a no-op.

5. **Directory Changes and Cancellation**
   - If a user changes directories before hooks finish, the supervisor may be signalled and the `HookExecutor::cancel_execution` path will mark the state as cancelled; supervisor processes are also signalled to terminate when possible. Shell handlers remain installed and will run the export flow for the new directory context on subsequent prompts.

## Consequences

- Shells remain clean after hooks execute, reducing surprises and resource leaks.
- Users can run commands immediately; environment injection happens when ready.
- Hook failures do not leave lingering handlers that would re-run or spam the user.

## Alignment with Features

| Feature Scenario | Impact |
| --- | --- |
| [features/cli/hooks.feature](features/cli/hooks.feature:9) — Environment loads after hooks complete | Affirmed by background execution and prompt-hook lifecycle. |
| [features/cli/hooks.feature](features/cli/hooks.feature:45) — Preexec checks while hooks run | Ensures prompt-hook handlers are idempotent during execution. |
| [features/cli/hooks.feature](features/cli/hooks.feature:78) — Shell-specific integration | Documents expectations for fish, bash, zsh prompt-hook behaviour. |

## Related Documents

- [docs/rfcs/rfc-0003-shell-integration-workflow-and-hook-lifecycle.md](docs/rfcs/rfc-0003-shell-integration-workflow-and-hook-lifecycle.md:1)
- [docs/adrs/adr-0001-hook-approval-gate-for-environment-loading.md](docs/adrs/adr-0001-hook-approval-gate-for-environment-loading.md:1)
- [crates/cuenv-cli/src/commands/hooks.rs](crates/cuenv-cli/src/commands/hooks.rs:238)

## Status

Accepted — behaviour live in the CLI and relied upon by shell integration scripts.

## Notes

Future shells (PowerShell, Nushell) MUST implement equivalent prompt-driven integration semantics. If automatic handler deregistration (self-unload) becomes a required UX or security property, a follow-up ADR should be produced to specify the contract and cross-shell implementation plan.