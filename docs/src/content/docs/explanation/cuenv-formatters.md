---
title: cuenv-formatters
description: Automatic code formatting for generated files after sync
---

The formatters system provides automatic code formatting for files generated by `cuenv sync cubes`. It integrates directly into the sync workflow, running formatters as a post-sync hook to ensure generated code matches your project's style guidelines.

## Overview

When you run `cuenv sync cubes`, generated files can be automatically formatted before being written to disk. This ensures:

- Consistent code style across generated files
- No manual formatting steps required
- CI-verifiable formatting with `--check` mode

## Architecture

```text
┌────────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│  cuenv sync cubes  │────►│  Cube Generator │────►│  Generated Files │
└────────────────────┘     └─────────────────┘     └────────┬─────────┘
                                                            │
                                                            ▼
┌────────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│  Formatted Files   │◄────│  Format Runner  │◄────│  Pattern Matcher │
└────────────────────┘     └─────────────────┘     └──────────────────┘
                                   │
                                   ▼
                           ┌─────────────────┐
                           │  Tool Executor  │
                           │ (rustfmt, etc.) │
                           └─────────────────┘
```

### Key Components

**Pattern Matcher**
Matches generated file paths against configured glob patterns. Patterns are matched relative to the project root, supporting recursive wildcards (`**`) and standard glob syntax.

**Format Runner**
Orchestrates formatter execution. Groups files by formatter type, invokes the appropriate tool, and collects results.

**Tool Executor**
Invokes external formatting tools (`rustfmt`, `nixfmt`, `gofmt`, `cue fmt`) with appropriate flags for normal and check modes.

## Configuration Schema

Formatters are configured in `#Base.formatters`:

```cue
#Formatters: {
    rust?: #RustFormatter
    nix?:  #NixFormatter
    go?:   #GoFormatter
    cue?:  #CueFormatter
}
```

Each formatter follows a common structure:

| Field | Type | Description |
|-------|------|-------------|
| `enabled` | `bool` | Enable/disable (default: `true`) |
| `includes` | `[...string]` | Glob patterns to match |

### RustFormatter

```cue
#RustFormatter: close({
    enabled:  bool | *true
    includes: [...string] | *["*.rs"]
    edition?: "2018" | "2021" | "2024"
})
```

The optional `edition` field passes `--edition` to rustfmt.

### NixFormatter

```cue
#NixFormatter: close({
    enabled:  bool | *true
    includes: [...string] | *["*.nix"]
    tool:     "nixfmt" | "alejandra" | *"nixfmt"
})
```

Supports two Nix formatters with different check flags:
- `nixfmt`: Uses `--check` for verification
- `alejandra`: Uses `-c` for verification

### GoFormatter

```cue
#GoFormatter: close({
    enabled:  bool | *true
    includes: [...string] | *["*.go"]
})
```

Uses `gofmt -w` for formatting and `gofmt -l` for check mode.

### CueFormatter

```cue
#CueFormatter: close({
    enabled:  bool | *true
    includes: [...string] | *["*.cue"]
})
```

Uses `cue fmt` for formatting and `cue fmt -d` for check mode (displays diffs).

## Pattern Matching

Patterns use standard glob syntax and are matched against relative paths from the project root:

```
project/
├── src/
│   └── lib.rs       → matched as "src/lib.rs"
├── tests/
│   └── test.rs      → matched as "tests/test.rs"
└── build.rs         → matched as "build.rs"
```

**Pattern examples:**

| Pattern | Matches |
|---------|---------|
| `*.rs` | Rust files in project root only |
| `**/*.rs` | All Rust files recursively |
| `src/**/*.rs` | Rust files under src/ |
| `crates/*/src/*.rs` | Rust files in any crate's src directory |

Invalid glob patterns are logged as warnings and skipped, rather than failing the entire operation.

## Execution Modes

### Normal Mode

```bash
cuenv sync cubes
```

Formats files in-place after generation. Only files that were actually written are formatted (not all files matching patterns).

### Check Mode

```bash
cuenv sync cubes --check
```

Verifies formatting without making changes. Returns non-zero exit code if any files need formatting. Useful for CI pipelines.

### Dry-Run Mode

```bash
cuenv sync cubes --dry-run
```

Shows what would be generated and formatted without writing files.

## Tool Commands

| Formatter | Normal Command | Check Command |
|-----------|---------------|---------------|
| rustfmt | `rustfmt [--edition X] <files>` | `rustfmt --check <files>` |
| nixfmt | `nixfmt <files>` | `nixfmt --check <files>` |
| alejandra | `alejandra <files>` | `alejandra -c <files>` |
| gofmt | `gofmt -w <files>` | `gofmt -l <files>` |
| cue fmt | `cue fmt <files>` | `cue fmt -d <files>` |

## Error Handling

- **Check mode failures**: Produce errors and exit non-zero
- **Normal mode failures**: Logged as warnings, execution continues
- **Invalid patterns**: Logged as warnings, pattern skipped
- **Missing tools**: Error with clear message about which tool is missing

## Integration Points

### Sync Workflow

Formatters run as the final step of `cuenv sync cubes`:

1. Cubes evaluate and generate file content
2. Files are written to disk
3. Pattern matcher identifies files for each formatter
4. Formatters execute on matched files
5. Results are reported to the user

### CI Pipelines

```yaml
- name: Check generated files
  run: cuenv sync cubes --check
```

This verifies both that generated files are up-to-date AND properly formatted.

## Rust Implementation

The formatter system is implemented in `crates/cuenv/src/commands/sync/formatters.rs`:

```rust
pub fn format_generated_files(
    files: &[&Path],
    formatters: &Formatters,
    project_root: &Path,
    dry_run: bool,
    check: bool,
) -> Result<String>
```

The function:
1. Converts absolute paths to relative paths from project root
2. Matches files against each formatter's patterns
3. Groups files by formatter type
4. Executes appropriate tool for each group
5. Aggregates and returns results

## See Also

- [Formatters How-to Guide](/how-to/formatters/) - Practical usage
- [Cubes](/how-to/cubes/) - Code generation
- [CUE Schema Reference](/reference/cue-schema/) - Complete schema documentation
