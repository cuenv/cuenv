---
id: ADR-0004
title: Environment Export Filtering Policy
status: Accepted
decision_date: 2025-09-25
approvers:
  - Core Maintainers
related_features:
  - features/cli/env.feature:1
  - features/cli/hooks.feature:104
supersedes: []
superseded_by: []
---

## Context

cuenv exposes evaluated environment variables through `env print`, `env check`, and the hidden `export` command. During implementation ([crates/cuenv-cli/src/commands/env.rs](crates/cuenv-cli/src/commands/env.rs:41), [crates/cuenv-cli/src/commands/hooks.rs](crates/cuenv-cli/src/commands/hooks.rs:264)) we introduced rules to protect secrets and ensure shell-safe output. To guarantee consistent, secure behaviour across releases, these rules must be formally adopted.

This ADR complements [rfc-0005-environment-export-and-exec-invocation-contracts](/decisions/rfcs/rfc-0005-environment-export-and-exec-invocation-contracts/).

## Decision

1. **Secret Redaction**

   - Values flagged as secrets MUST NOT appear in any CLI output produced by `env print`, `env check`, or `export`. The placeholder `[SECRET]` MUST be stripped entirely rather than printed.

2. **Deterministic Ordering**

   - Exported environment variables MUST be sorted alphabetically for stable diffs and scripting friendliness.

3. **Shell-Specific Formats**

   - `env check`/`export` MUST emit shell-specific statements (`export KEY="VALUE"` for Bash/Zsh, `set -x KEY "VALUE"` for Fish) using the same filtered dataset.

4. **Hook-Augmented Values**

   - Environment variables produced by hook execution MAY be merged into the exported dataset but are subject to the same filtering rules.

5. **JSON Output**
   - JSON format MUST mirror the structure emitted by `serde_json::to_string_pretty`, omitting secrets while preserving other metadata.

## Consequences

- Secrets remain protected when users inspect or load environments.
- Scripts can rely on deterministic exports regardless of hook runtime.
- Shell integration scripts generated by `shell init` inherit the same guarantees.

## Alignment with Features

| Feature Scenario                                                                                           | Impact                                                   |
| ---------------------------------------------------------------------------------------------------------- | -------------------------------------------------------- |
| [features/cli/env.feature](features/cli/env.feature:1) — Pending scenarios                                 | Must verify secret filtering and deterministic ordering. |
| [features/cli/hooks.feature](features/cli/hooks.feature:104) — Environment variables persist after loading | Relies on merged hook variables obeying filtering rules. |

## Related Documents

- [rfc-0005-environment-export-and-exec-invocation-contracts](/decisions/rfcs/rfc-0005-environment-export-and-exec-invocation-contracts/)
- [crates/cuenv-cli/src/commands/env.rs](crates/cuenv-cli/src/commands/env.rs:41)
- [crates/cuenv-cli/src/commands/hooks.rs](crates/cuenv-cli/src/commands/hooks.rs:264)

## Status

Accepted — behaviour currently implemented in the CLI.

## Notes

Future support for additional shells MUST implement equivalent formatting while adhering to the same filtering policy.
