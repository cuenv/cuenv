name: release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag to release (e.g., 0.6.0)'
        required: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  publish-cue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true
            experimental-features = nix-command flakes

      - name: Publish CUE module
        run: nix develop --accept-flake-config --command cue mod publish v${{ inputs.tag_name || github.event.release.tag_name }}
        env:
          CUE_REGISTRY: registry.cue.works
          CUE_TOKEN: ${{ secrets.CUE_TOKEN }}

  build-release-artifacts:
    runs-on: ${{ matrix.os }}
    env:
      CUENV_FOREGROUND_HOOKS: "1"
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix (Unix)
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true
            experimental-features = nix-command flakes
        if: matrix.os != 'windows-latest'

      - name: Install devenv (Unix)
        run: nix profile install --accept-flake-config nixpkgs#devenv
        if: matrix.os != 'windows-latest'

      - name: Install Rust (Windows)
        uses: dtolnay/rust-toolchain@stable
        if: matrix.os == 'windows-latest'

      - name: Install Go (Windows)
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
        if: matrix.os == 'windows-latest'

      - name: Build development environment (Unix)
        run: nix develop --accept-flake-config --command echo "Development environment ready"
        if: matrix.os != 'windows-latest'

      - name: Build cuenv (Unix)
        run: |
          nix build .#cuenv
          mkdir -p bin
          cp -L result/bin/cuenv bin/cuenv
        if: matrix.os != 'windows-latest'

      - name: Setup cuenv (Unix)
        run: |
          chmod +x bin/cuenv
          echo "$(pwd)/bin" >> $GITHUB_PATH
        if: matrix.os != 'windows-latest'

      - name: Build release (Unix)
        run: cuenv task release.build
        if: matrix.os != 'windows-latest'

      - name: Build release (Windows)
        run: cargo build --workspace --release
        if: matrix.os == 'windows-latest'

      - name: Create archive (Unix)
        run: |
          mkdir -p release-artifacts
          if [ "${{ matrix.archive }}" = "tar.gz" ]; then
            tar czf "release-artifacts/cuenv-${{ github.event.release.tag_name }}-${{ matrix.target }}.tar.gz" \
              -C target/release \
              $(ls target/release/ | grep -E '^(cuenv|cuengine)$' || true)
          fi
        if: matrix.os != 'windows-latest'

      - name: Create archive (Windows)
        run: |
          mkdir release-artifacts
          Compress-Archive -Path "target/release/*.exe" -DestinationPath "release-artifacts/cuenv-${{ github.event.release.tag_name }}-${{ matrix.target }}.zip"
        if: matrix.os == 'windows-latest'
        shell: pwsh

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: release-artifacts/*

  upload-release-assets:
    runs-on: ubuntu-latest
    needs: [build-release-artifacts]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload release assets
        run: |
          for artifact_dir in artifacts/release-*; do
            if [ -d "$artifact_dir" ]; then
              for file in "$artifact_dir"/*; do
                if [ -f "$file" ]; then
                  gh release upload "${{ github.event.release.tag_name }}" "$file"
                fi
              done
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    runs-on: ubuntu-latest
    needs: upload-release-assets
    steps:
      - uses: actions/checkout@v4

      - name: Update Homebrew Formula
        env:
          TAG_NAME: ${{ inputs.tag_name || github.event.release.tag_name }}
          TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Calculate SHA256 of the source tarball
          URL="https://github.com/cuenv/cuenv/archive/refs/tags/${TAG_NAME}.tar.gz"
          echo "Downloading source from $URL..."
          curl -L -o source.tar.gz "$URL"
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          rm source.tar.gz
          echo "Calculated SHA256: $SHA256"

          # Clone the tap repository
          echo "Cloning homebrew-tap..."
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/cuenv/homebrew-tap.git" tap

          # Update the formula
          mkdir -p tap/Formula

          # Replace URL and SHA256 in the formula
          sed -e "s|url \".*\"|url \"$URL\"|" \
              -e "s|sha256 \".*\"|sha256 \"$SHA256\"|" \
              Formula/cuenv.rb > tap/Formula/cuenv.rb

          echo "Updated formula content:"
          head -n 10 tap/Formula/cuenv.rb

          # Commit and push
          cd tap
          if [[ -n $(git status -s) ]]; then
            git add Formula/cuenv.rb
            git commit -m "bump: cuenv ${TAG_NAME}"
            git push origin main || { echo 'Failed to push to homebrew-tap'; exit 1; }
            echo "Successfully pushed to homebrew-tap"
          else
             echo "No changes to formula detected"
          fi
