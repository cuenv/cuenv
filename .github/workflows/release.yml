name: release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to release (e.g., 0.6.0)"
        required: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  publish-cue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true
            experimental-features = nix-command flakes

      - name: Login to CUE registry
        run: nix develop --accept-flake-config --command cue login --token=${{ secrets.CUE_REGISTRY_TOKEN }}
        env:
          CUE_REGISTRY: registry.cue.works

      - name: Publish CUE module
        run: nix develop --accept-flake-config --command cue mod publish v${{ inputs.tag_name || github.event.release.tag_name }}
        env:
          CUE_REGISTRY: registry.cue.works

  publish-crates:
    runs-on: ubuntu-latest
    needs: [publish-cue]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true
            experimental-features = nix-command flakes

      - uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Publish Crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          nix develop --accept-flake-config --command bash -c "
            echo 'Publishing cuenv-events...'
            cargo publish -p cuenv-events
            sleep 30
            
            echo 'Publishing cuenv-workspaces...'
            cargo publish -p cuenv-workspaces
            sleep 30
            
            echo 'Publishing cuenv-core...'
            cargo publish -p cuenv-core
            sleep 30
            
            echo 'Publishing cuengine...'
            cargo publish -p cuengine
            sleep 30
            
            echo 'Publishing cuenv-dagger...'
            cargo publish -p cuenv-dagger
            sleep 30
            
            echo 'Publishing cuenv-ci...'
            cargo publish -p cuenv-ci
            sleep 30
            
            echo 'Publishing cuenv-release...'
            cargo publish -p cuenv-release
            sleep 30
            
            echo 'Publishing cuenv...'
            cargo publish -p cuenv
          "

  build-release-artifacts:
    runs-on: ${{ matrix.os }}
    env:
      CUENV_FOREGROUND_HOOKS: "1"
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - os: macos-latest
            target: x86_64-apple-darwin

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true
            experimental-features = nix-command flakes

      - name: Install devenv
        run: nix profile install --accept-flake-config nixpkgs#devenv

      - name: Build development environment
        run: nix develop --accept-flake-config --command echo "Development environment ready"

      - name: Build cuenv (Bootstrap)
        run: |
          nix build .#cuenv
          mkdir -p bin
          cp -L result/bin/cuenv bin/cuenv

      - name: Setup cuenv
        run: |
          chmod +x bin/cuenv
          echo "$(pwd)/bin" >> $GITHUB_PATH

      - name: Build release
        run: |
          if [[ "${{ matrix.target }}" == *"musl"* ]]; then
             echo "Building static binary for ${{ matrix.target }}"
             nix build .#cuenv-static
          else
             echo "Building dynamic binary for ${{ matrix.target }}"
             # We can use cuenv task here if we want, or just nix build
             # cuenv task release.build might be preferred if it does extra stuff?
             # But let's match the static path for consistency
             nix build .#cuenv
          fi

          # Prepare artifacts for the archive step
          mkdir -p target/release
          # Nix output might be in result/bin
          cp -L result/bin/cuenv target/release/cuenv
          # Check for other binaries if needed (e.g. cuengine?)
          if [ -f result/bin/cuengine ]; then
            cp -L result/bin/cuengine target/release/cuengine
          fi

      - name: Create archive
        run: |
          mkdir -p release-artifacts
          tar czf "release-artifacts/cuenv-${{ github.event.release.tag_name }}-${{ matrix.target }}.tar.gz" \
            -C target/release \
            $(ls target/release/ | grep -E '^(cuenv|cuengine)$' || true)

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: release-artifacts/*

  upload-release-assets:
    runs-on: ubuntu-latest
    needs: [build-release-artifacts]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload release assets
        run: |
          for artifact_dir in artifacts/release-*; do
            if [ -d "$artifact_dir" ]; then
              for file in "$artifact_dir"/*; do
                if [ -f "$file" ]; then
                  gh release upload "${{ github.event.release.tag_name }}" "$file"
                fi
              done
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    runs-on: ubuntu-latest
    needs: upload-release-assets
    steps:
      - uses: actions/checkout@v4

      - name: Update Homebrew Formula
        env:
          TAG_NAME: ${{ inputs.tag_name || github.event.release.tag_name }}
          TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Calculate SHA256 of the source tarball
          URL="https://github.com/cuenv/cuenv/archive/refs/tags/${TAG_NAME}.tar.gz"
          echo "Downloading source from $URL..."
          curl -L -o source.tar.gz "$URL"
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          rm source.tar.gz
          echo "Calculated SHA256: $SHA256"

          # Clone the tap repository
          echo "Cloning homebrew-tap..."
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/cuenv/homebrew-tap.git" tap

          # Update the formula
          mkdir -p tap/Formula

          # Replace URL and SHA256 in the formula
          sed -e "s|url \".*\"|url \"$URL\"|" \
              -e "s|sha256 \".*\"|sha256 \"$SHA256\"|" \
              Formula/cuenv.rb > tap/Formula/cuenv.rb

          echo "Updated formula content:"
          head -n 10 tap/Formula/cuenv.rb

          # Commit and push
          cd tap
          if [[ -n $(git status -s) ]]; then
            git add Formula/cuenv.rb
            git commit -m "bump: cuenv ${TAG_NAME}"
            git push origin main || { echo 'Failed to push to homebrew-tap'; exit 1; }
            echo "Successfully pushed to homebrew-tap"
          else
             echo "No changes to formula detected"
          fi
