name: release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to release (e.g., 0.6.0)"
        required: true

permissions:
  contents: write
  id-token: write

jobs:
  # Run release pipeline and build artifacts in parallel
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: cuenv
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          pushFilter: '(-source$|nixpkgs\.tar\.gz$)'

      - name: Build cuenv (Bootstrap)
        run: |
          nix build .#cuenv
          echo "$(pwd)/result/bin" >> $GITHUB_PATH

      - name: Smoke test bootstrap cuenv
        run: cuenv --version

      - uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Run Release Pipeline
        run: cuenv ci --pipeline release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: v${{ inputs.tag_name || github.event.release.tag_name }}
          CUE_REGISTRY: registry.cue.works
          CUE_REGISTRY_TOKEN: ${{ secrets.CUE_REGISTRY_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x86_64
            goarch: amd64
          - target: aarch64-unknown-linux-gnu
            arch: aarch64
            goarch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo-zigbuild
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-zigbuild
          key: cargo-zigbuild-0.19

      - name: Install cargo-zigbuild
        run: |
          if [ ! -f ~/.cargo/bin/cargo-zigbuild ]; then
            cargo install cargo-zigbuild
          fi

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: crates/cuengine/go.sum

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: ${{ matrix.target }}

      - name: Build Go bridge for target
        working-directory: crates/cuengine
        run: |
          mkdir -p ../../target/release

          export CGO_ENABLED=1
          export GOOS=linux
          export GOARCH=${{ matrix.goarch }}
          export CC="zig cc -target ${{ matrix.arch }}-linux-gnu"
          export CXX="zig c++ -target ${{ matrix.arch }}-linux-gnu"
          export AR="zig ar"

          go build -buildmode=c-archive -o ../../target/release/libcue_bridge.a bridge.go
          cp libcue_bridge.h ../../target/release/

      - name: Build with cargo-zigbuild
        run: cargo zigbuild --release --target ${{ matrix.target }} -p cuenv

      - name: Smoke test (native only)
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: ./target/${{ matrix.target }}/release/cuenv --version

      - name: Create archive
        run: |
          mkdir -p release-artifacts
          tar czf "release-artifacts/cuenv-${{ github.event.release.tag_name || inputs.tag_name }}-${{ matrix.target }}.tar.gz" \
            -C target/${{ matrix.target }}/release cuenv

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: release-artifacts/*

  build-macos:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: macos-13
            target: x86_64-apple-darwin
          - runner: macos-14
            target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: cuenv
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          pushFilter: '(-source$|nixpkgs\.tar\.gz$)'

      - name: Build release
        run: |
          nix build .#cuenv
          mkdir -p target/release
          cp -L result/bin/cuenv target/release/cuenv

      - name: Smoke test
        run: ./target/release/cuenv --version

      - name: Create archive
        run: |
          mkdir -p release-artifacts
          tar czf "release-artifacts/cuenv-${{ github.event.release.tag_name || inputs.tag_name }}-${{ matrix.target }}.tar.gz" \
            -C target/release cuenv

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: release-artifacts/*

  upload-release-assets:
    runs-on: ubuntu-latest
    needs: [release, build-linux, build-macos]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload release assets
        run: |
          for artifact_dir in artifacts/release-*; do
            if [ -d "$artifact_dir" ]; then
              for file in "$artifact_dir"/*; do
                if [ -f "$file" ]; then
                  gh release upload "${{ github.event.release.tag_name || inputs.tag_name }}" "$file"
                fi
              done
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    runs-on: ubuntu-latest
    needs: upload-release-assets
    steps:
      - uses: actions/checkout@v4

      - name: Update Homebrew Formula
        env:
          TAG_NAME: ${{ inputs.tag_name || github.event.release.tag_name }}
          TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          URL="https://github.com/cuenv/cuenv/archive/refs/tags/${TAG_NAME}.tar.gz"
          curl -L -o source.tar.gz "$URL"
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          rm source.tar.gz

          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/cuenv/homebrew-tap.git" tap
          mkdir -p tap/Formula

          sed -e "s|url \".*\"|url \"$URL\"|" \
              -e "s|sha256 \".*\"|sha256 \"$SHA256\"|" \
              Formula/cuenv.rb > tap/Formula/cuenv.rb

          cd tap
          if [[ -n $(git status -s) ]]; then
            git add Formula/cuenv.rb
            git commit -m "bump: cuenv ${TAG_NAME}"
            git push origin main
          fi
