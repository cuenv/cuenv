name: release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to release (e.g., 0.6.0)"
        required: true

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: cuenv
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          pushFilter: '(-source$|nixpkgs\.tar\.gz$)'

      - name: Build cuenv (Bootstrap)
        run: |
          nix build .#cuenv
          echo "$(pwd)/result/bin" >> $GITHUB_PATH

      - uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Run Release Pipeline
        run: cuenv ci --pipeline release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: v${{ inputs.tag_name || github.event.release.tag_name }}
          CUE_REGISTRY: registry.cue.works
          CUE_REGISTRY_TOKEN: ${{ secrets.CUE_REGISTRY_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  # Matrix builds for release artifacts (cuenv doesn't support matrix yet)
  build-release-artifacts:
    runs-on: ${{ matrix.os }}
    needs: [release]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - os: macos-latest
            target: x86_64-apple-darwin

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: cuenv
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          pushFilter: '(-source$|nixpkgs\.tar\.gz$)'

      - name: Build release
        run: |
          if [[ "${{ matrix.target }}" == *"musl"* ]]; then
            nix build .#cuenv-static
          else
            nix build .#cuenv
          fi
          mkdir -p target/release
          cp -L result/bin/cuenv target/release/cuenv

      - name: Smoke test built binary
        run: |
          ./target/release/cuenv --version

      - name: Create archive
        run: |
          mkdir -p release-artifacts
          tar czf "release-artifacts/cuenv-${{ github.event.release.tag_name }}-${{ matrix.target }}.tar.gz" \
            -C target/release cuenv

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: release-artifacts/*

  upload-release-assets:
    runs-on: ubuntu-latest
    needs: [build-release-artifacts]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload release assets
        run: |
          for artifact_dir in artifacts/release-*; do
            if [ -d "$artifact_dir" ]; then
              for file in "$artifact_dir"/*; do
                if [ -f "$file" ]; then
                  gh release upload "${{ github.event.release.tag_name }}" "$file"
                fi
              done
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    runs-on: ubuntu-latest
    needs: upload-release-assets
    steps:
      - uses: actions/checkout@v4

      - name: Update Homebrew Formula
        env:
          TAG_NAME: ${{ inputs.tag_name || github.event.release.tag_name }}
          TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          URL="https://github.com/cuenv/cuenv/archive/refs/tags/${TAG_NAME}.tar.gz"
          curl -L -o source.tar.gz "$URL"
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          rm source.tar.gz

          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/cuenv/homebrew-tap.git" tap
          mkdir -p tap/Formula

          sed -e "s|url \".*\"|url \"$URL\"|" \
              -e "s|sha256 \".*\"|sha256 \"$SHA256\"|" \
              Formula/cuenv.rb > tap/Formula/cuenv.rb

          cd tap
          if [[ -n $(git status -s) ]]; then
            git add Formula/cuenv.rb
            git commit -m "bump: cuenv ${TAG_NAME}"
            git push origin main
          fi
