name: Release PR

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v16
        with:
          extra-conf: |
            accept-flake-config = true

      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v2

      - name: Build cuenv (Bootstrap)
        run: |
          nix build .#cuenv
          echo "$(pwd)/result/bin" >> $GITHUB_PATH

      - name: Get latest tag
        id: tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "latest=$TAG" >> $GITHUB_OUTPUT

      - name: Check for existing pending changesets
        id: check_existing
        run: |
          STATUS=$(cuenv changeset status --json 2>&1) || true
          HAS_PENDING=$(echo "$STATUS" | jq -r '.has_pending // false')
          if [ "$HAS_PENDING" = "true" ]; then
            echo "has_pending=true" >> $GITHUB_OUTPUT
          else
            echo "has_pending=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate changeset from commits
        if: steps.check_existing.outputs.has_pending == 'false'
        run: |
          if [ -n "${{ steps.tag.outputs.latest }}" ]; then
            cuenv changeset from-commits --since "${{ steps.tag.outputs.latest }}" || true
          else
            cuenv changeset from-commits || true
          fi

      - name: Check for pending changesets
        id: check
        run: |
          STATUS=$(cuenv changeset status --json 2>&1) || true
          HAS_PENDING=$(echo "$STATUS" | jq -r '.has_pending // false')
          if [ "$HAS_PENDING" = "true" ]; then
            echo "has_changesets=true" >> $GITHUB_OUTPUT
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate version bump (dry run)
        if: steps.check.outputs.has_changesets == 'true'
        id: version
        run: |
          cuenv release version --dry-run > version_summary.txt 2>&1 || true
          cat version_summary.txt
          {
            echo "summary<<CUENV_VERSION_SUMMARY_END"
            cat version_summary.txt
            echo "CUENV_VERSION_SUMMARY_END"
          } >> $GITHUB_OUTPUT
          rm version_summary.txt

      - name: Apply version changes
        if: steps.check.outputs.has_changesets == 'true'
        run: cuenv release version

      - name: Create Release PR
        if: steps.check.outputs.has_changesets == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: release"
          title: "chore: release"
          body: |
            ## Release

            This PR was auto-generated by cuenv release.

            ### Version Changes

            ```
            ${{ steps.version.outputs.summary || 'See version_summary.txt' }}
            ```

            ---

            Merge this PR and then create a GitHub Release to trigger publishing.
          branch: release/next
          delete-branch: true
          labels: release
