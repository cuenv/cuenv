name: Release PR

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "examples/**"
      - "*.md"
      - "LICENSE"
      - ".vscode/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  release-pr:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup cuenv
        uses: cuenv/setup-cuenv@v1

      - name: Get latest tag
        id: tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "latest=$TAG" >> $GITHUB_OUTPUT

      - name: Check for existing pending changesets
        id: check_existing
        run: |
          STATUS=$(cuenv changeset status --json 2>&1) || true
          HAS_PENDING=$(echo "$STATUS" | jq -r '.has_pending // false')
          echo "has_pending=$HAS_PENDING" >> $GITHUB_OUTPUT

      - name: Generate changeset from commits
        if: steps.check_existing.outputs.has_pending == 'false'
        run: |
          if [ -n "${{ steps.tag.outputs.latest }}" ]; then
            cuenv changeset from-commits --since "${{ steps.tag.outputs.latest }}" || true
          else
            cuenv changeset from-commits || true
          fi

      - name: Check for pending changesets
        id: check
        run: |
          STATUS=$(cuenv changeset status --json 2>&1) || true
          HAS_PENDING=$(echo "$STATUS" | jq -r '.has_pending // false')
          echo "has_changesets=$HAS_PENDING" >> $GITHUB_OUTPUT

      - name: Calculate version bump (dry run)
        if: steps.check.outputs.has_changesets == 'true'
        id: version
        run: |
          cuenv release version --dry-run > version_summary.txt 2>&1 || true
          cat version_summary.txt
          {
            echo "summary<<CUENV_VERSION_SUMMARY_END"
            cat version_summary.txt
            echo "CUENV_VERSION_SUMMARY_END"
          } >> $GITHUB_OUTPUT

      - name: Apply version changes
        if: steps.check.outputs.has_changesets == 'true'
        run: cuenv release version

      - name: Create Release PR
        if: steps.check.outputs.has_changesets == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: release"
          title: "chore: release"
          body: |
            ## Release

            This PR was auto-generated by cuenv release.

            ### Version Changes

            ```
            ${{ steps.version.outputs.summary || 'See version_summary.txt' }}
            ```

            ---

            Merge this PR and then create a GitHub Release to trigger publishing.
          branch: release/next
          delete-branch: true
          labels: release
