{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Cuenv",
  "description": "Root Cuenv configuration structure",
  "type": "object",
  "properties": {
    "ci": {
      "description": "CI configuration",
      "anyOf": [
        {
          "$ref": "#/$defs/CI"
        },
        {
          "type": "null"
        }
      ]
    },
    "config": {
      "description": "Configuration settings",
      "anyOf": [
        {
          "$ref": "#/$defs/Config"
        },
        {
          "type": "null"
        }
      ]
    },
    "env": {
      "description": "Environment variables configuration",
      "anyOf": [
        {
          "$ref": "#/$defs/Env"
        },
        {
          "type": "null"
        }
      ]
    },
    "hooks": {
      "description": "Hooks configuration",
      "anyOf": [
        {
          "$ref": "#/$defs/Hooks"
        },
        {
          "type": "null"
        }
      ]
    },
    "tasks": {
      "description": "Tasks configuration",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/TaskDefinition"
      },
      "default": {}
    },
    "workspaces": {
      "description": "Workspaces configuration",
      "type": ["object", "null"],
      "additionalProperties": {
        "$ref": "#/$defs/WorkspaceConfig"
      }
    }
  },
  "$defs": {
    "CI": {
      "type": "object",
      "properties": {
        "pipelines": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Pipeline"
          }
        }
      },
      "required": ["pipelines"]
    },
    "CacheMode": {
      "description": "Cache mode options",
      "type": "string",
      "enum": ["off", "read", "read-write", "write"]
    },
    "Config": {
      "description": "Main configuration structure for cuenv",
      "type": "object",
      "properties": {
        "auditMode": {
          "description": "Security and debugging",
          "type": ["boolean", "null"]
        },
        "cacheEnabled": {
          "type": ["boolean", "null"]
        },
        "cacheMode": {
          "description": "Cache configuration",
          "anyOf": [
            {
              "$ref": "#/$defs/CacheMode"
            },
            {
              "type": "null"
            }
          ]
        },
        "defaultCapabilities": {
          "type": ["array", "null"],
          "items": {
            "type": "string"
          }
        },
        "defaultEnvironment": {
          "description": "Default environment settings",
          "type": ["string", "null"]
        },
        "outputFormat": {
          "description": "Task output format",
          "anyOf": [
            {
              "$ref": "#/$defs/OutputFormat"
            },
            {
              "type": "null"
            }
          ]
        },
        "traceOutput": {
          "description": "Chrome trace generation",
          "type": ["boolean", "null"]
        }
      }
    },
    "Env": {
      "description": "Environment configuration with environment-specific overrides\nBased on schema/env.cue",
      "type": "object",
      "properties": {
        "environment": {
          "description": "Environment-specific overrides",
          "type": ["object", "null"],
          "additionalProperties": {
            "type": "object",
            "additionalProperties": {
              "$ref": "#/$defs/EnvValue"
            }
          }
        }
      },
      "additionalProperties": {
        "$ref": "#/$defs/EnvValue"
      }
    },
    "EnvValue": {
      "description": "Environment variable values can be strings, integers, booleans, secrets, or values with policies\nWhen exported to actual environment, these will always be strings",
      "anyOf": [
        {
          "$ref": "#/$defs/EnvVarWithPolicies"
        },
        {
          "type": "string"
        },
        {
          "type": "integer",
          "format": "int64"
        },
        {
          "type": "boolean"
        },
        {
          "$ref": "#/$defs/Secret"
        }
      ]
    },
    "EnvValueSimple": {
      "description": "Simple environment variable values (non-recursive)",
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "integer",
          "format": "int64"
        },
        {
          "type": "boolean"
        },
        {
          "$ref": "#/$defs/Secret"
        }
      ]
    },
    "EnvVarWithPolicies": {
      "description": "Environment variable with optional access policies",
      "type": "object",
      "properties": {
        "policies": {
          "description": "Optional access policies",
          "type": ["array", "null"],
          "items": {
            "$ref": "#/$defs/Policy"
          }
        },
        "value": {
          "description": "The actual value",
          "$ref": "#/$defs/EnvValueSimple"
        }
      },
      "required": ["value"]
    },
    "Hook": {
      "description": "A hook represents a command that can be executed when entering or exiting environments\nBased on schema/hooks.cue #ExecHook definition",
      "type": "object",
      "properties": {
        "args": {
          "description": "Arguments to pass to the command",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "command": {
          "description": "The command to execute",
          "type": "string"
        },
        "dir": {
          "description": "Working directory for command execution (defaults to \".\")",
          "type": ["string", "null"],
          "default": null
        },
        "inputs": {
          "description": "Input files that trigger re-execution when changed",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "order": {
          "description": "Execution order within a single env.cue (lower runs first, default 100)",
          "type": "integer",
          "format": "int32",
          "default": 100
        },
        "propagate": {
          "description": "Whether this hook propagates to child directories (default false)",
          "type": "boolean",
          "default": false
        },
        "source": {
          "description": "Whether to source the command output as shell script to capture environment changes",
          "type": ["boolean", "null"]
        }
      },
      "required": ["command"]
    },
    "Hooks": {
      "description": "Collection of hooks that can be executed",
      "type": "object",
      "properties": {
        "onEnter": {
          "description": "Named hooks to execute when entering an environment (map of name -> hook)",
          "type": ["object", "null"],
          "additionalProperties": {
            "$ref": "#/$defs/Hook"
          }
        },
        "onExit": {
          "description": "Named hooks to execute when exiting an environment (map of name -> hook)",
          "type": ["object", "null"],
          "additionalProperties": {
            "$ref": "#/$defs/Hook"
          }
        }
      }
    },
    "Input": {
      "description": "A single task input definition",
      "anyOf": [
        {
          "description": "Local path/glob input",
          "type": "string"
        },
        {
          "description": "Cross-project reference",
          "$ref": "#/$defs/ProjectReference"
        }
      ]
    },
    "Mapping": {
      "description": "Mapping of external output to local workspace path",
      "type": "object",
      "properties": {
        "from": {
          "description": "Path relative to external project root of a declared output from the external task",
          "type": "string"
        },
        "to": {
          "description": "Path inside the dependent taskâ€™s hermetic workspace where this file/dir will be materialized",
          "type": "string"
        }
      },
      "required": ["from", "to"]
    },
    "OutputFormat": {
      "description": "Task output format options",
      "type": "string",
      "enum": ["tui", "spinner", "simple", "tree", "json"]
    },
    "Pipeline": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "tasks": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "when": {
          "anyOf": [
            {
              "$ref": "#/$defs/PipelineCondition"
            },
            {
              "type": "null"
            }
          ]
        }
      },
      "required": ["name", "tasks"]
    },
    "PipelineCondition": {
      "type": "object",
      "properties": {
        "branch": {
          "anyOf": [
            {
              "$ref": "#/$defs/StringOrVec"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "defaultBranch": {
          "type": ["boolean", "null"]
        },
        "manual": {
          "type": ["boolean", "null"]
        },
        "pullRequest": {
          "type": ["boolean", "null"]
        },
        "scheduled": {
          "type": ["boolean", "null"]
        },
        "tag": {
          "anyOf": [
            {
              "$ref": "#/$defs/StringOrVec"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        }
      }
    },
    "Policy": {
      "description": "Policy for controlling environment variable access",
      "type": "object",
      "properties": {
        "allowExec": {
          "description": "Allowlist of exec commands that can access this variable",
          "type": ["array", "null"],
          "items": {
            "type": "string"
          }
        },
        "allowTasks": {
          "description": "Allowlist of task names that can access this variable",
          "type": ["array", "null"],
          "items": {
            "type": "string"
          }
        }
      }
    },
    "ProjectReference": {
      "description": "Cross-project input declaration",
      "type": "object",
      "properties": {
        "map": {
          "description": "Required explicit mappings",
          "type": "array",
          "items": {
            "$ref": "#/$defs/Mapping"
          }
        },
        "project": {
          "description": "Path to project root relative to env.cue or absolute-from-repo-root",
          "type": "string"
        },
        "task": {
          "description": "Name of the external task in that project",
          "type": "string"
        }
      },
      "required": ["project", "task", "map"]
    },
    "Secret": {
      "description": "Secret definition with resolver\nThis is the base type that can be extended in CUE",
      "type": "object",
      "properties": {
        "args": {
          "description": "Arguments to pass to the command",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "command": {
          "description": "Command to execute",
          "type": "string"
        },
        "resolver": {
          "description": "Resolver type (currently only \"exec\" is supported)",
          "type": "string"
        }
      },
      "additionalProperties": true,
      "required": ["resolver", "command"]
    },
    "Shell": {
      "description": "Shell configuration for task execution",
      "type": "object",
      "properties": {
        "command": {
          "description": "Shell executable name (e.g., \"bash\", \"fish\", \"zsh\")",
          "type": ["string", "null"]
        },
        "flag": {
          "description": "Flag for command execution (e.g., \"-c\", \"--command\")",
          "type": ["string", "null"]
        }
      }
    },
    "StringOrVec": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      ]
    },
    "Task": {
      "description": "A single executable task",
      "type": "object",
      "properties": {
        "args": {
          "description": "Arguments for the command",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "command": {
          "description": "Command to execute",
          "type": "string"
        },
        "dependsOn": {
          "description": "Task dependencies (names of tasks that must run first)",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "description": {
          "description": "Description of the task",
          "type": ["string", "null"],
          "default": null
        },
        "env": {
          "description": "Environment variables for this task",
          "type": "object",
          "additionalProperties": true,
          "default": {}
        },
        "hermetic": {
          "description": "When true (default), task runs in isolated hermetic directory.\nWhen false, task runs directly in workspace/project root.",
          "type": "boolean",
          "default": true
        },
        "inputs": {
          "description": "Input files/resources",
          "type": "array",
          "default": [],
          "items": {
            "$ref": "#/$defs/Input"
          }
        },
        "inputsFrom": {
          "description": "Consume cached outputs from other tasks in the same project",
          "type": ["array", "null"],
          "default": null,
          "items": {
            "$ref": "#/$defs/TaskOutput"
          }
        },
        "outputs": {
          "description": "Output files/resources",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "shell": {
          "description": "Shell configuration for command execution (optional)",
          "anyOf": [
            {
              "$ref": "#/$defs/Shell"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "workspaces": {
          "description": "Workspaces to mount/enable for this task",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        }
      },
      "required": ["command"]
    },
    "TaskDefinition": {
      "description": "A task definition can be either a single task or a group of tasks",
      "anyOf": [
        {
          "description": "A single task",
          "$ref": "#/$defs/Task"
        },
        {
          "description": "A group of tasks",
          "$ref": "#/$defs/TaskGroup"
        }
      ]
    },
    "TaskGroup": {
      "description": "Represents a group of tasks with execution mode",
      "anyOf": [
        {
          "description": "Sequential execution: array of tasks executed in order",
          "type": "array",
          "items": {
            "$ref": "#/$defs/TaskDefinition"
          }
        },
        {
          "description": "Parallel execution: named tasks that can run concurrently",
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/TaskDefinition"
          }
        }
      ]
    },
    "TaskOutput": {
      "description": "Reference to another task's outputs within the same project",
      "type": "object",
      "properties": {
        "map": {
          "description": "Optional explicit mapping of outputs. If omitted, all outputs are\nmaterialized at their original paths in the hermetic workspace.",
          "type": ["array", "null"],
          "default": null,
          "items": {
            "$ref": "#/$defs/Mapping"
          }
        },
        "task": {
          "description": "Name of the task whose cached outputs to consume (e.g. \"docs.build\")",
          "type": "string"
        }
      },
      "required": ["task"]
    },
    "WorkspaceConfig": {
      "description": "Workspace configuration",
      "type": "object",
      "properties": {
        "enabled": {
          "description": "Enable or disable the workspace",
          "type": "boolean",
          "default": true
        },
        "packageManager": {
          "description": "Optional: manually specify the package manager",
          "type": ["string", "null"]
        },
        "root": {
          "description": "Optional: manually specify the root of the workspace relative to env.cue",
          "type": ["string", "null"]
        }
      }
    }
  }
}
